// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © arzerchriskry

//@version=6
indicator("TradeBuddy Times + Events", overlay=true, max_lines_count=500, max_labels_count=500)

// Paste format (from TradeBuddy "TradingView Input kopieren"):
// yyyy-MM-dd HH:mm|icon|city
// Example:
// 2026-02-09 00:16|☀️↑|Berlin

entriesInput = input.text_area(
     defval =
         "2026-02-09 00:16|☀️↑|Berlin\n" +
         "2026-02-09 01:41|🌙↑|Berlin\n" +
         "2026-02-09 02:04|✨|Berlin\n",
     title = "TradeBuddy Events (eine pro Zeile oder mit Komma getrennt)"
)

string tz = "Etc/UTC"

showLines = input.bool(true, "Vertikale Linien")
showIcons = input.bool(true, "Event-Icons")

f_ts(dateTimeRaw) =>
    s = str.trim(dateTimeRaw)
    parts = str.split(s, " ")
    if array.size(parts) != 2
        na
    else
        d = array.get(parts, 0)
        t = array.get(parts, 1)
        dparts = str.split(d, "-")
        tparts = str.split(t, ":")
        if array.size(dparts) != 3 or array.size(tparts) < 2
            na
        else
            y   = int(str.tonumber(array.get(dparts, 0)))
            m   = int(str.tonumber(array.get(dparts, 1)))
            day = int(str.tonumber(array.get(dparts, 2)))
            hh  = int(str.tonumber(array.get(tparts, 0)))
            mm  = int(str.tonumber(array.get(tparts, 1)))
            timestamp(tz, y, m, day, hh, mm)

f_city_alias(cityRaw) =>
    c = str.trim(cityRaw)
    lc = str.lower(c)
    str.contains(lc, "new york") or str.contains(lc, "nyc") or lc == "ny" ? "NY" :
     str.contains(lc, "frankfurt") or str.contains(lc, "ffm") or lc == "fra" ? "FRA" :
     str.contains(lc, "london") ? "LDN" :
     str.contains(lc, "tokyo") or str.contains(lc, "tokio") ? "TYO" :
     str.contains(lc, "shanghai") ? "SHA" :
     str.contains(lc, "hong kong") or str.contains(lc, "hongkong") ? "HKG" :
     str.contains(lc, "singapur") or str.contains(lc, "singapore") or str.contains(lc, "sgp") ? "SG" :
     str.contains(lc, "sydney") ? "SYD" :
     str.length(c) >= 3 ? str.upper(str.substring(c, 0, 3)) : str.upper(c)

f_icon_alias(iconRaw) =>
    u = str.upper(str.trim(iconRaw))
    str.contains(u, "SUN") and str.contains(u, "UP") ? "SUN↑" :
     str.contains(u, "SUN") and str.contains(u, "DOWN") ? "SUN↓" :
     str.contains(u, "MOON") and str.contains(u, "UP") ? "MOON↑" :
     str.contains(u, "MOON") and str.contains(u, "DOWN") ? "MOON↓" :
     str.contains(u, "ASTRO") ? "ASTRO" :
     str.trim(iconRaw)

var tsArr = array.new_int()
var iconArr = array.new_string()
var cityArr = array.new_string()
var shownArr = array.new_bool()

if barstate.isfirst
    clean = entriesInput
    clean := str.replace_all(clean, ";", ",")
    clean := str.replace_all(clean, "\n", ",")
    clean := str.replace_all(clean, "\r", ",")

    parts = str.split(clean, ",")
    for i = 0 to array.size(parts) - 1
        raw = str.trim(array.get(parts, i))
        if str.length(raw) > 0 and not str.startswith(raw, "#")
            fields = str.split(raw, "|")
            dt = array.size(fields) >= 1 ? str.trim(array.get(fields, 0)) : ""
            icon = array.size(fields) >= 2 ? str.trim(array.get(fields, 1)) : "•"
            city = array.size(fields) >= 3 ? str.trim(array.get(fields, 2)) : ""

            ts = f_ts(dt)
            if not na(ts)
                array.push(tsArr, ts)
                array.push(iconArr, str.length(icon) > 0 ? icon : "•")
                array.push(cityArr, city)
                array.push(shownArr, false)

                lineColor = color.new(color.teal, 0)
                if str.contains(icon, "☀") or str.contains(str.upper(icon), "SUN")
                    lineColor := color.new(color.orange, 0)
                else if str.contains(icon, "🌙") or str.contains(str.upper(icon), "MOON")
                    lineColor := color.new(color.aqua, 0)

                if showLines
                    line.new(ts, 0, ts, 1,
                        xloc=xloc.bar_time,
                        extend=extend.both,
                        color=lineColor,
                        style=line.style_dotted,
                        width=1)

barLabelText = ""
barEventCount = 0
firstIcon = ""
firstCity = ""

for i = 0 to array.size(tsArr) - 1
    wasShown = array.get(shownArr, i)
    if not wasShown
        ts = array.get(tsArr, i)
        inBar = time <= ts and ts < time_close
        if inBar and showIcons
            icon = f_icon_alias(array.get(iconArr, i))
            city = array.get(cityArr, i)
            cityAlias = f_city_alias(city)
            eventText = str.length(cityAlias) > 0 ? icon + " " + cityAlias : icon
            barLabelText := barEventCount == 0 ? eventText : barLabelText + " | " + eventText
            if barEventCount == 0
                firstIcon := icon
                firstCity := cityAlias
            barEventCount += 1
            array.set(shownArr, i, true)

hasBarEvents = showIcons and barEventCount > 0

isSunUp = firstIcon == "SUN↑"
isSunDown = firstIcon == "SUN↓"
isMoonUp = firstIcon == "MOON↑"
isMoonDown = firstIcon == "MOON↓"
isAstro = firstIcon == "ASTRO"

plotshape(hasBarEvents and isSunUp and firstCity == "NY", title="SUN_UP_NY", style=shape.labelup, location=location.bottom, text="SUN↑ NY", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "NY", title="SUN_DOWN_NY", style=shape.labelup, location=location.bottom, text="SUN↓ NY", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "NY", title="MOON_UP_NY", style=shape.labelup, location=location.bottom, text="MOON↑ NY", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "NY", title="MOON_DOWN_NY", style=shape.labelup, location=location.bottom, text="MOON↓ NY", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "NY", title="ASTRO_NY", style=shape.labelup, location=location.bottom, text="ASTRO NY", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity == "FRA", title="SUN_UP_FRA", style=shape.labelup, location=location.bottom, text="SUN↑ FRA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "FRA", title="SUN_DOWN_FRA", style=shape.labelup, location=location.bottom, text="SUN↓ FRA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "FRA", title="MOON_UP_FRA", style=shape.labelup, location=location.bottom, text="MOON↑ FRA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "FRA", title="MOON_DOWN_FRA", style=shape.labelup, location=location.bottom, text="MOON↓ FRA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "FRA", title="ASTRO_FRA", style=shape.labelup, location=location.bottom, text="ASTRO FRA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity == "LDN", title="SUN_UP_LDN", style=shape.labelup, location=location.bottom, text="SUN↑ LDN", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "LDN", title="SUN_DOWN_LDN", style=shape.labelup, location=location.bottom, text="SUN↓ LDN", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "LDN", title="MOON_UP_LDN", style=shape.labelup, location=location.bottom, text="MOON↑ LDN", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "LDN", title="MOON_DOWN_LDN", style=shape.labelup, location=location.bottom, text="MOON↓ LDN", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "LDN", title="ASTRO_LDN", style=shape.labelup, location=location.bottom, text="ASTRO LDN", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity == "TYO", title="SUN_UP_TYO", style=shape.labelup, location=location.bottom, text="SUN↑ TYO", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "TYO", title="SUN_DOWN_TYO", style=shape.labelup, location=location.bottom, text="SUN↓ TYO", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "TYO", title="MOON_UP_TYO", style=shape.labelup, location=location.bottom, text="MOON↑ TYO", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "TYO", title="MOON_DOWN_TYO", style=shape.labelup, location=location.bottom, text="MOON↓ TYO", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "TYO", title="ASTRO_TYO", style=shape.labelup, location=location.bottom, text="ASTRO TYO", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity == "SHA", title="SUN_UP_SHA", style=shape.labelup, location=location.bottom, text="SUN↑ SHA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "SHA", title="SUN_DOWN_SHA", style=shape.labelup, location=location.bottom, text="SUN↓ SHA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "SHA", title="MOON_UP_SHA", style=shape.labelup, location=location.bottom, text="MOON↑ SHA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "SHA", title="MOON_DOWN_SHA", style=shape.labelup, location=location.bottom, text="MOON↓ SHA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "SHA", title="ASTRO_SHA", style=shape.labelup, location=location.bottom, text="ASTRO SHA", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity == "HKG", title="SUN_UP_HKG", style=shape.labelup, location=location.bottom, text="SUN↑ HKG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "HKG", title="SUN_DOWN_HKG", style=shape.labelup, location=location.bottom, text="SUN↓ HKG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "HKG", title="MOON_UP_HKG", style=shape.labelup, location=location.bottom, text="MOON↑ HKG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "HKG", title="MOON_DOWN_HKG", style=shape.labelup, location=location.bottom, text="MOON↓ HKG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "HKG", title="ASTRO_HKG", style=shape.labelup, location=location.bottom, text="ASTRO HKG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity == "SG", title="SUN_UP_SG", style=shape.labelup, location=location.bottom, text="SUN↑ SG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "SG", title="SUN_DOWN_SG", style=shape.labelup, location=location.bottom, text="SUN↓ SG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "SG", title="MOON_UP_SG", style=shape.labelup, location=location.bottom, text="MOON↑ SG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "SG", title="MOON_DOWN_SG", style=shape.labelup, location=location.bottom, text="MOON↓ SG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "SG", title="ASTRO_SG", style=shape.labelup, location=location.bottom, text="ASTRO SG", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity == "SYD", title="SUN_UP_SYD", style=shape.labelup, location=location.bottom, text="SUN↑ SYD", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity == "SYD", title="SUN_DOWN_SYD", style=shape.labelup, location=location.bottom, text="SUN↓ SYD", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity == "SYD", title="MOON_UP_SYD", style=shape.labelup, location=location.bottom, text="MOON↑ SYD", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity == "SYD", title="MOON_DOWN_SYD", style=shape.labelup, location=location.bottom, text="MOON↓ SYD", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity == "SYD", title="ASTRO_SYD", style=shape.labelup, location=location.bottom, text="ASTRO SYD", textcolor=color.white, color=color.new(color.black, 70), size=size.large)

plotshape(hasBarEvents and isSunUp and firstCity != "NY" and firstCity != "FRA" and firstCity != "LDN" and firstCity != "TYO" and firstCity != "SHA" and firstCity != "HKG" and firstCity != "SG" and firstCity != "SYD", title="SUN_UP_OTHER", style=shape.labelup, location=location.bottom, text="SUN↑ EVT", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isSunDown and firstCity != "NY" and firstCity != "FRA" and firstCity != "LDN" and firstCity != "TYO" and firstCity != "SHA" and firstCity != "HKG" and firstCity != "SG" and firstCity != "SYD", title="SUN_DOWN_OTHER", style=shape.labelup, location=location.bottom, text="SUN↓ EVT", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonUp and firstCity != "NY" and firstCity != "FRA" and firstCity != "LDN" and firstCity != "TYO" and firstCity != "SHA" and firstCity != "HKG" and firstCity != "SG" and firstCity != "SYD", title="MOON_UP_OTHER", style=shape.labelup, location=location.bottom, text="MOON↑ EVT", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isMoonDown and firstCity != "NY" and firstCity != "FRA" and firstCity != "LDN" and firstCity != "TYO" and firstCity != "SHA" and firstCity != "HKG" and firstCity != "SG" and firstCity != "SYD", title="MOON_DOWN_OTHER", style=shape.labelup, location=location.bottom, text="MOON↓ EVT", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
plotshape(hasBarEvents and isAstro and firstCity != "NY" and firstCity != "FRA" and firstCity != "LDN" and firstCity != "TYO" and firstCity != "SHA" and firstCity != "HKG" and firstCity != "SG" and firstCity != "SYD", title="ASTRO_OTHER", style=shape.labelup, location=location.bottom, text="ASTRO EVT", textcolor=color.white, color=color.new(color.black, 70), size=size.large)
