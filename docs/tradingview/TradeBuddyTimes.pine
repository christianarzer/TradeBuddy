// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© arzerchriskry

//@version=6
indicator("TradeBuddy Times + Events", overlay=true, max_lines_count=500, max_labels_count=500)

// Paste format (from TradeBuddy "TradingView Input kopieren"):
// yyyy-MM-dd HH:mm|icon|city
// Example:
// 2026-02-09 00:16|SUN_UP|Berlin

entriesInput = input.text_area(
     defval =
         "2026-02-09 00:16|SUN_UP|Berlin\n" +
         "2026-02-09 01:41|MOON_UP|Berlin\n" +
         "2026-02-09 02:04|ASTRO|Berlin\n",
     title = "TradeBuddy Events (eine pro Zeile oder mit Komma getrennt)"
)

string tz = "Etc/UTC"

showLines = input.bool(true, "Vertikale Linien")
showIcons = input.bool(true, "Event-Icons")

f_ts(dateTimeRaw) =>
    s = str.trim(dateTimeRaw)
    parts = str.split(s, " ")
    if array.size(parts) != 2
        na
    else
        d = array.get(parts, 0)
        t = array.get(parts, 1)
        dparts = str.split(d, "-")
        tparts = str.split(t, ":")
        if array.size(dparts) != 3 or array.size(tparts) < 2
            na
        else
            y   = int(str.tonumber(array.get(dparts, 0)))
            m   = int(str.tonumber(array.get(dparts, 1)))
            day = int(str.tonumber(array.get(dparts, 2)))
            hh  = int(str.tonumber(array.get(tparts, 0)))
            mm  = int(str.tonumber(array.get(tparts, 1)))
            timestamp(tz, y, m, day, hh, mm)

// Returns a numeric city ID for matching against const strings
// 0=NY, 1=FRA, 2=LDN, 3=TYO, 4=SHA, 5=HKG, 6=SG, 7=SYD, 8=BER, 9=OTHER
f_city_id(cityRaw) =>
    c = str.trim(cityRaw)
    lc = str.lower(c)
    str.contains(lc, "new york") or str.contains(lc, "nyc") or lc == "ny" ? 0 :
     str.contains(lc, "frankfurt") or str.contains(lc, "ffm") or lc == "fra" ? 1 :
     str.contains(lc, "london") ? 2 :
     str.contains(lc, "tokyo") or str.contains(lc, "tokio") ? 3 :
     str.contains(lc, "shanghai") ? 4 :
     str.contains(lc, "hong kong") or str.contains(lc, "hongkong") ? 5 :
     str.contains(lc, "singapur") or str.contains(lc, "singapore") or str.contains(lc, "sgp") ? 6 :
     str.contains(lc, "sydney") ? 7 :
     str.contains(lc, "berlin") or str.contains(lc, "ber") ? 8 :
     9

// Returns a numeric icon ID for matching
// 0=SUNâ†‘, 1=SUNâ†“, 2=MOONâ†‘, 3=MOONâ†“, 4=ASTRO, 5=OTHER
f_icon_id(iconRaw) =>
    u = str.upper(str.trim(iconRaw))
    str.contains(u, "SUN") and (str.contains(u, "UP") or str.contains(u, "â†‘")) ? 0 :
     str.contains(u, "SUN") and (str.contains(u, "DOWN") or str.contains(u, "â†“")) ? 1 :
     str.contains(u, "MOON") and (str.contains(u, "UP") or str.contains(u, "â†‘")) ? 2 :
     str.contains(u, "MOON") and (str.contains(u, "DOWN") or str.contains(u, "â†“")) ? 3 :
     str.contains(u, "ASTRO") or str.contains(u, "âœ¨") ? 4 :
     str.contains(u, "â˜€") and str.contains(u, "â†‘") ? 0 :
     str.contains(u, "â˜€") and str.contains(u, "â†“") ? 1 :
     str.contains(u, "ðŸŒ™") and str.contains(u, "â†‘") ? 2 :
     str.contains(u, "ðŸŒ™") and str.contains(u, "â†“") ? 3 :
     5

var tsArr = array.new_int()
var iconIdArr = array.new_int()
var cityIdArr = array.new_int()
var shownArr = array.new_bool()

if barstate.isfirst
    clean = entriesInput
    clean := str.replace_all(clean, ";", ",")
    clean := str.replace_all(clean, "\n", ",")
    clean := str.replace_all(clean, "\r", ",")

    parts = str.split(clean, ",")
    for i = 0 to array.size(parts) - 1
        raw = str.trim(array.get(parts, i))
        if str.length(raw) > 0 and not str.startswith(raw, "#")
            fields = str.split(raw, "|")
            dt = array.size(fields) >= 1 ? str.trim(array.get(fields, 0)) : ""
            icon = array.size(fields) >= 2 ? str.trim(array.get(fields, 1)) : "â€¢"
            city = array.size(fields) >= 3 ? str.trim(array.get(fields, 2)) : ""

            ts = f_ts(dt)
            if not na(ts)
                array.push(tsArr, ts)
                array.push(iconIdArr, f_icon_id(icon))
                array.push(cityIdArr, f_city_id(city))
                array.push(shownArr, false)

                lineColor = color.new(color.teal, 0)
                iconId = f_icon_id(icon)
                if iconId == 0 or iconId == 1
                    lineColor := color.new(color.orange, 0)
                else if iconId == 2 or iconId == 3
                    lineColor := color.new(color.aqua, 0)

                if showLines
                    line.new(ts, 0, ts, 1,
                        xloc=xloc.bar_time,
                        extend=extend.both,
                        color=lineColor,
                        style=line.style_dotted,
                        width=1)

// Collect up to 3 events per bar
slot1_icon = -1
slot1_city = -1
slot2_icon = -1
slot2_city = -1
slot3_icon = -1
slot3_city = -1
slotCount = 0

for i = 0 to array.size(tsArr) - 1
    wasShown = array.get(shownArr, i)
    if not wasShown
        ts = array.get(tsArr, i)
        inBar = time <= ts and ts < time_close
        if inBar and showIcons
            if slotCount == 0
                slot1_icon := array.get(iconIdArr, i)
                slot1_city := array.get(cityIdArr, i)
            else if slotCount == 1
                slot2_icon := array.get(iconIdArr, i)
                slot2_city := array.get(cityIdArr, i)
            else if slotCount == 2
                slot3_icon := array.get(iconIdArr, i)
                slot3_city := array.get(cityIdArr, i)
            slotCount += 1
            array.set(shownArr, i, true)

has1 = showIcons and slotCount >= 1
has2 = showIcons and slotCount >= 2
has3 = showIcons and slotCount >= 3

// â”€â”€ Icon colors â”€â”€
s1_sun   = slot1_icon == 0 or slot1_icon == 1
s1_moon  = slot1_icon == 2 or slot1_icon == 3
s1_astro = slot1_icon == 4
s1_color = s1_sun ? color.new(#FF8C00, 20) : s1_moon ? color.new(#00BFFF, 20) : s1_astro ? color.new(#9370DB, 20) : color.new(color.black, 70)

s2_sun   = slot2_icon == 0 or slot2_icon == 1
s2_moon  = slot2_icon == 2 or slot2_icon == 3
s2_astro = slot2_icon == 4
s2_color = s2_sun ? color.new(#FF8C00, 20) : s2_moon ? color.new(#00BFFF, 20) : s2_astro ? color.new(#9370DB, 20) : color.new(color.black, 70)

s3_sun   = slot3_icon == 0 or slot3_icon == 1
s3_moon  = slot3_icon == 2 or slot3_icon == 3
s3_astro = slot3_icon == 4
s3_color = s3_sun ? color.new(#FF8C00, 20) : s3_moon ? color.new(#00BFFF, 20) : s3_astro ? color.new(#9370DB, 20) : color.new(color.black, 70)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SLOT 1 â€“ plotshape per icon Ã— city (bottom-pinned)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// --- SUNâ†‘ ---
plotshape(has1 and slot1_icon==0 and slot1_city==0, title="S1_SU_NY",  style=shape.labelup, location=location.bottom, text="â˜€â†‘ NY",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==1, title="S1_SU_FRA", style=shape.labelup, location=location.bottom, text="â˜€â†‘ FRA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==2, title="S1_SU_LDN", style=shape.labelup, location=location.bottom, text="â˜€â†‘ LDN", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==3, title="S1_SU_TYO", style=shape.labelup, location=location.bottom, text="â˜€â†‘ TYO", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==4, title="S1_SU_SHA", style=shape.labelup, location=location.bottom, text="â˜€â†‘ SHA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==5, title="S1_SU_HKG", style=shape.labelup, location=location.bottom, text="â˜€â†‘ HKG", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==6, title="S1_SU_SG",  style=shape.labelup, location=location.bottom, text="â˜€â†‘ SG",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==7, title="S1_SU_SYD", style=shape.labelup, location=location.bottom, text="â˜€â†‘ SYD", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==8, title="S1_SU_BER", style=shape.labelup, location=location.bottom, text="â˜€â†‘ BER", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==0 and slot1_city==9, title="S1_SU_OTH", style=shape.labelup, location=location.bottom, text="â˜€â†‘",     textcolor=color.white, color=s1_color, size=size.small)
// --- SUNâ†“ ---
plotshape(has1 and slot1_icon==1 and slot1_city==0, title="S1_SD_NY",  style=shape.labelup, location=location.bottom, text="â˜€â†“ NY",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==1, title="S1_SD_FRA", style=shape.labelup, location=location.bottom, text="â˜€â†“ FRA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==2, title="S1_SD_LDN", style=shape.labelup, location=location.bottom, text="â˜€â†“ LDN", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==3, title="S1_SD_TYO", style=shape.labelup, location=location.bottom, text="â˜€â†“ TYO", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==4, title="S1_SD_SHA", style=shape.labelup, location=location.bottom, text="â˜€â†“ SHA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==5, title="S1_SD_HKG", style=shape.labelup, location=location.bottom, text="â˜€â†“ HKG", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==6, title="S1_SD_SG",  style=shape.labelup, location=location.bottom, text="â˜€â†“ SG",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==7, title="S1_SD_SYD", style=shape.labelup, location=location.bottom, text="â˜€â†“ SYD", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==8, title="S1_SD_BER", style=shape.labelup, location=location.bottom, text="â˜€â†“ BER", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==1 and slot1_city==9, title="S1_SD_OTH", style=shape.labelup, location=location.bottom, text="â˜€â†“",     textcolor=color.white, color=s1_color, size=size.small)
// --- MOONâ†‘ ---
plotshape(has1 and slot1_icon==2 and slot1_city==0, title="S1_MU_NY",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ NY",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==1, title="S1_MU_FRA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ FRA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==2, title="S1_MU_LDN", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ LDN", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==3, title="S1_MU_TYO", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ TYO", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==4, title="S1_MU_SHA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SHA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==5, title="S1_MU_HKG", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ HKG", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==6, title="S1_MU_SG",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SG",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==7, title="S1_MU_SYD", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SYD", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==8, title="S1_MU_BER", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ BER", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==2 and slot1_city==9, title="S1_MU_OTH", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘",     textcolor=color.white, color=s1_color, size=size.small)
// --- MOONâ†“ ---
plotshape(has1 and slot1_icon==3 and slot1_city==0, title="S1_MD_NY",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ NY",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==1, title="S1_MD_FRA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ FRA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==2, title="S1_MD_LDN", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ LDN", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==3, title="S1_MD_TYO", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ TYO", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==4, title="S1_MD_SHA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SHA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==5, title="S1_MD_HKG", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ HKG", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==6, title="S1_MD_SG",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SG",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==7, title="S1_MD_SYD", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SYD", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==8, title="S1_MD_BER", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ BER", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==3 and slot1_city==9, title="S1_MD_OTH", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“",     textcolor=color.white, color=s1_color, size=size.small)
// --- ASTRO ---
plotshape(has1 and slot1_icon==4 and slot1_city==0, title="S1_AS_NY",  style=shape.labelup, location=location.bottom, text="âœ¨ NY",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==1, title="S1_AS_FRA", style=shape.labelup, location=location.bottom, text="âœ¨ FRA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==2, title="S1_AS_LDN", style=shape.labelup, location=location.bottom, text="âœ¨ LDN", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==3, title="S1_AS_TYO", style=shape.labelup, location=location.bottom, text="âœ¨ TYO", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==4, title="S1_AS_SHA", style=shape.labelup, location=location.bottom, text="âœ¨ SHA", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==5, title="S1_AS_HKG", style=shape.labelup, location=location.bottom, text="âœ¨ HKG", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==6, title="S1_AS_SG",  style=shape.labelup, location=location.bottom, text="âœ¨ SG",  textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==7, title="S1_AS_SYD", style=shape.labelup, location=location.bottom, text="âœ¨ SYD", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==8, title="S1_AS_BER", style=shape.labelup, location=location.bottom, text="âœ¨ BER", textcolor=color.white, color=s1_color, size=size.small)
plotshape(has1 and slot1_icon==4 and slot1_city==9, title="S1_AS_OTH", style=shape.labelup, location=location.bottom, text="âœ¨",     textcolor=color.white, color=s1_color, size=size.small)
// --- OTHER icon ---
plotshape(has1 and slot1_icon==5, title="S1_OT", style=shape.labelup, location=location.bottom, text="â€¢", textcolor=color.white, color=s1_color, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SLOT 2 â€“ second event on same bar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// --- SUNâ†‘ ---
plotshape(has2 and slot2_icon==0 and slot2_city==0, title="S2_SU_NY",  style=shape.labelup, location=location.bottom, text="â˜€â†‘ NY",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==1, title="S2_SU_FRA", style=shape.labelup, location=location.bottom, text="â˜€â†‘ FRA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==2, title="S2_SU_LDN", style=shape.labelup, location=location.bottom, text="â˜€â†‘ LDN", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==3, title="S2_SU_TYO", style=shape.labelup, location=location.bottom, text="â˜€â†‘ TYO", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==4, title="S2_SU_SHA", style=shape.labelup, location=location.bottom, text="â˜€â†‘ SHA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==5, title="S2_SU_HKG", style=shape.labelup, location=location.bottom, text="â˜€â†‘ HKG", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==6, title="S2_SU_SG",  style=shape.labelup, location=location.bottom, text="â˜€â†‘ SG",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==7, title="S2_SU_SYD", style=shape.labelup, location=location.bottom, text="â˜€â†‘ SYD", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==8, title="S2_SU_BER", style=shape.labelup, location=location.bottom, text="â˜€â†‘ BER", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==0 and slot2_city==9, title="S2_SU_OTH", style=shape.labelup, location=location.bottom, text="â˜€â†‘",     textcolor=color.white, color=s2_color, size=size.small)
// --- SUNâ†“ ---
plotshape(has2 and slot2_icon==1 and slot2_city==0, title="S2_SD_NY",  style=shape.labelup, location=location.bottom, text="â˜€â†“ NY",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==1, title="S2_SD_FRA", style=shape.labelup, location=location.bottom, text="â˜€â†“ FRA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==2, title="S2_SD_LDN", style=shape.labelup, location=location.bottom, text="â˜€â†“ LDN", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==3, title="S2_SD_TYO", style=shape.labelup, location=location.bottom, text="â˜€â†“ TYO", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==4, title="S2_SD_SHA", style=shape.labelup, location=location.bottom, text="â˜€â†“ SHA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==5, title="S2_SD_HKG", style=shape.labelup, location=location.bottom, text="â˜€â†“ HKG", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==6, title="S2_SD_SG",  style=shape.labelup, location=location.bottom, text="â˜€â†“ SG",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==7, title="S2_SD_SYD", style=shape.labelup, location=location.bottom, text="â˜€â†“ SYD", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==8, title="S2_SD_BER", style=shape.labelup, location=location.bottom, text="â˜€â†“ BER", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==1 and slot2_city==9, title="S2_SD_OTH", style=shape.labelup, location=location.bottom, text="â˜€â†“",     textcolor=color.white, color=s2_color, size=size.small)
// --- MOONâ†‘ ---
plotshape(has2 and slot2_icon==2 and slot2_city==0, title="S2_MU_NY",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ NY",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==1, title="S2_MU_FRA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ FRA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==2, title="S2_MU_LDN", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ LDN", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==3, title="S2_MU_TYO", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ TYO", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==4, title="S2_MU_SHA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SHA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==5, title="S2_MU_HKG", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ HKG", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==6, title="S2_MU_SG",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SG",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==7, title="S2_MU_SYD", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SYD", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==8, title="S2_MU_BER", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ BER", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==2 and slot2_city==9, title="S2_MU_OTH", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘",     textcolor=color.white, color=s2_color, size=size.small)
// --- MOONâ†“ ---
plotshape(has2 and slot2_icon==3 and slot2_city==0, title="S2_MD_NY",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ NY",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==1, title="S2_MD_FRA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ FRA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==2, title="S2_MD_LDN", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ LDN", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==3, title="S2_MD_TYO", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ TYO", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==4, title="S2_MD_SHA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SHA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==5, title="S2_MD_HKG", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ HKG", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==6, title="S2_MD_SG",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SG",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==7, title="S2_MD_SYD", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SYD", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==8, title="S2_MD_BER", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ BER", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==3 and slot2_city==9, title="S2_MD_OTH", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“",     textcolor=color.white, color=s2_color, size=size.small)
// --- ASTRO ---
plotshape(has2 and slot2_icon==4 and slot2_city==0, title="S2_AS_NY",  style=shape.labelup, location=location.bottom, text="âœ¨ NY",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==1, title="S2_AS_FRA", style=shape.labelup, location=location.bottom, text="âœ¨ FRA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==2, title="S2_AS_LDN", style=shape.labelup, location=location.bottom, text="âœ¨ LDN", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==3, title="S2_AS_TYO", style=shape.labelup, location=location.bottom, text="âœ¨ TYO", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==4, title="S2_AS_SHA", style=shape.labelup, location=location.bottom, text="âœ¨ SHA", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==5, title="S2_AS_HKG", style=shape.labelup, location=location.bottom, text="âœ¨ HKG", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==6, title="S2_AS_SG",  style=shape.labelup, location=location.bottom, text="âœ¨ SG",  textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==7, title="S2_AS_SYD", style=shape.labelup, location=location.bottom, text="âœ¨ SYD", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==8, title="S2_AS_BER", style=shape.labelup, location=location.bottom, text="âœ¨ BER", textcolor=color.white, color=s2_color, size=size.small)
plotshape(has2 and slot2_icon==4 and slot2_city==9, title="S2_AS_OTH", style=shape.labelup, location=location.bottom, text="âœ¨",     textcolor=color.white, color=s2_color, size=size.small)
// --- OTHER icon ---
plotshape(has2 and slot2_icon==5, title="S2_OT", style=shape.labelup, location=location.bottom, text="â€¢", textcolor=color.white, color=s2_color, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SLOT 3 â€“ third event on same bar
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// --- SUNâ†‘ ---
plotshape(has3 and slot3_icon==0 and slot3_city==0, title="S3_SU_NY",  style=shape.labelup, location=location.bottom, text="â˜€â†‘ NY",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==1, title="S3_SU_FRA", style=shape.labelup, location=location.bottom, text="â˜€â†‘ FRA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==2, title="S3_SU_LDN", style=shape.labelup, location=location.bottom, text="â˜€â†‘ LDN", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==3, title="S3_SU_TYO", style=shape.labelup, location=location.bottom, text="â˜€â†‘ TYO", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==4, title="S3_SU_SHA", style=shape.labelup, location=location.bottom, text="â˜€â†‘ SHA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==5, title="S3_SU_HKG", style=shape.labelup, location=location.bottom, text="â˜€â†‘ HKG", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==6, title="S3_SU_SG",  style=shape.labelup, location=location.bottom, text="â˜€â†‘ SG",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==7, title="S3_SU_SYD", style=shape.labelup, location=location.bottom, text="â˜€â†‘ SYD", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==8, title="S3_SU_BER", style=shape.labelup, location=location.bottom, text="â˜€â†‘ BER", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==0 and slot3_city==9, title="S3_SU_OTH", style=shape.labelup, location=location.bottom, text="â˜€â†‘",     textcolor=color.white, color=s3_color, size=size.small)
// --- SUNâ†“ ---
plotshape(has3 and slot3_icon==1 and slot3_city==0, title="S3_SD_NY",  style=shape.labelup, location=location.bottom, text="â˜€â†“ NY",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==1, title="S3_SD_FRA", style=shape.labelup, location=location.bottom, text="â˜€â†“ FRA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==2, title="S3_SD_LDN", style=shape.labelup, location=location.bottom, text="â˜€â†“ LDN", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==3, title="S3_SD_TYO", style=shape.labelup, location=location.bottom, text="â˜€â†“ TYO", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==4, title="S3_SD_SHA", style=shape.labelup, location=location.bottom, text="â˜€â†“ SHA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==5, title="S3_SD_HKG", style=shape.labelup, location=location.bottom, text="â˜€â†“ HKG", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==6, title="S3_SD_SG",  style=shape.labelup, location=location.bottom, text="â˜€â†“ SG",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==7, title="S3_SD_SYD", style=shape.labelup, location=location.bottom, text="â˜€â†“ SYD", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==8, title="S3_SD_BER", style=shape.labelup, location=location.bottom, text="â˜€â†“ BER", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==1 and slot3_city==9, title="S3_SD_OTH", style=shape.labelup, location=location.bottom, text="â˜€â†“",     textcolor=color.white, color=s3_color, size=size.small)
// --- MOONâ†‘ ---
plotshape(has3 and slot3_icon==2 and slot3_city==0, title="S3_MU_NY",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ NY",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==1, title="S3_MU_FRA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ FRA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==2, title="S3_MU_LDN", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ LDN", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==3, title="S3_MU_TYO", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ TYO", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==4, title="S3_MU_SHA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SHA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==5, title="S3_MU_HKG", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ HKG", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==6, title="S3_MU_SG",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SG",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==7, title="S3_MU_SYD", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ SYD", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==8, title="S3_MU_BER", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘ BER", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==2 and slot3_city==9, title="S3_MU_OTH", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†‘",     textcolor=color.white, color=s3_color, size=size.small)
// --- MOONâ†“ ---
plotshape(has3 and slot3_icon==3 and slot3_city==0, title="S3_MD_NY",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ NY",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==1, title="S3_MD_FRA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ FRA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==2, title="S3_MD_LDN", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ LDN", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==3, title="S3_MD_TYO", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ TYO", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==4, title="S3_MD_SHA", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SHA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==5, title="S3_MD_HKG", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ HKG", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==6, title="S3_MD_SG",  style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SG",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==7, title="S3_MD_SYD", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ SYD", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==8, title="S3_MD_BER", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“ BER", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==3 and slot3_city==9, title="S3_MD_OTH", style=shape.labelup, location=location.bottom, text="ðŸŒ™â†“",     textcolor=color.white, color=s3_color, size=size.small)
// --- ASTRO ---
plotshape(has3 and slot3_icon==4 and slot3_city==0, title="S3_AS_NY",  style=shape.labelup, location=location.bottom, text="âœ¨ NY",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==1, title="S3_AS_FRA", style=shape.labelup, location=location.bottom, text="âœ¨ FRA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==2, title="S3_AS_LDN", style=shape.labelup, location=location.bottom, text="âœ¨ LDN", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==3, title="S3_AS_TYO", style=shape.labelup, location=location.bottom, text="âœ¨ TYO", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==4, title="S3_AS_SHA", style=shape.labelup, location=location.bottom, text="âœ¨ SHA", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==5, title="S3_AS_HKG", style=shape.labelup, location=location.bottom, text="âœ¨ HKG", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==6, title="S3_AS_SG",  style=shape.labelup, location=location.bottom, text="âœ¨ SG",  textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==7, title="S3_AS_SYD", style=shape.labelup, location=location.bottom, text="âœ¨ SYD", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==8, title="S3_AS_BER", style=shape.labelup, location=location.bottom, text="âœ¨ BER", textcolor=color.white, color=s3_color, size=size.small)
plotshape(has3 and slot3_icon==4 and slot3_city==9, title="S3_AS_OTH", style=shape.labelup, location=location.bottom, text="âœ¨",     textcolor=color.white, color=s3_color, size=size.small)
// --- OTHER icon ---
plotshape(has3 and slot3_icon==5, title="S3_OT", style=shape.labelup, location=location.bottom, text="â€¢", textcolor=color.white, color=s3_color, size=size.small)

// â”€â”€ Overflow indicator: 4+ events on one bar â”€â”€
plotshape(showIcons and slotCount > 3, title="OVERFLOW", style=shape.labelup, location=location.bottom, text="+", textcolor=color.yellow, color=color.new(color.red, 30), size=size.small)
