// This Pine Script¬Æ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© arzerchriskry

//@version=6
indicator("TradeBuddy Times + Events", overlay=true, max_lines_count=500, max_labels_count=500)

// Paste format (from TradeBuddy "TradingView Input kopieren"):
// yyyy-MM-dd HH:mm|icon|city
// Example:
// 2026-02-09 00:16|SUN_UP|Berlin

entriesInput = input.text_area(
     defval =
         "2026-02-09 00:16|SUN_UP|Berlin\n" +
         "2026-02-09 01:41|MOON_UP|Berlin\n" +
         "2026-02-09 02:04|ASTRO|Berlin\n",
     title = "TradeBuddy Events (eine pro Zeile oder mit Komma getrennt)"
)

string tz = "Etc/UTC"

showLines = input.bool(true, "Vertikale Linien")
showIcons = input.bool(true, "Event-Icons")

f_ts(dateTimeRaw) =>
    s = str.trim(dateTimeRaw)
    parts = str.split(s, " ")
    if array.size(parts) != 2
        na
    else
        d = array.get(parts, 0)
        t = array.get(parts, 1)
        dparts = str.split(d, "-")
        tparts = str.split(t, ":")
        if array.size(dparts) != 3 or array.size(tparts) < 2
            na
        else
            y   = int(str.tonumber(array.get(dparts, 0)))
            m   = int(str.tonumber(array.get(dparts, 1)))
            day = int(str.tonumber(array.get(dparts, 2)))
            hh  = int(str.tonumber(array.get(tparts, 0)))
            mm  = int(str.tonumber(array.get(tparts, 1)))
            timestamp(tz, y, m, day, hh, mm)

// Returns a numeric city ID for matching against const strings
// 0=NY, 1=FRA, 2=LDN, 3=TYO, 4=BER, 5=OTHER
f_city_id(cityRaw) =>
    c = str.trim(cityRaw)
    lc = str.lower(c)
    str.contains(lc, "new york") or str.contains(lc, "nyc") or lc == "ny" ? 0 :
     str.contains(lc, "frankfurt") or str.contains(lc, "ffm") or lc == "fra" ? 1 :
     str.contains(lc, "london") ? 2 :
     str.contains(lc, "tokyo") or str.contains(lc, "tokio") ? 3 :
     str.contains(lc, "berlin") or str.contains(lc, "ber") ? 4 :
     5

// Returns a numeric icon ID for matching
// 0=SUN‚Üë, 1=SUN‚Üì, 2=MOON‚Üë, 3=MOON‚Üì, 4=ASTRO, 5=OTHER
f_icon_id(iconRaw) =>
    u = str.upper(str.trim(iconRaw))
    str.contains(u, "SUN") and (str.contains(u, "UP") or str.contains(u, "‚Üë")) ? 0 :
     str.contains(u, "SUN") and (str.contains(u, "DOWN") or str.contains(u, "‚Üì")) ? 1 :
     str.contains(u, "MOON") and (str.contains(u, "UP") or str.contains(u, "‚Üë")) ? 2 :
     str.contains(u, "MOON") and (str.contains(u, "DOWN") or str.contains(u, "‚Üì")) ? 3 :
     str.contains(u, "ASTRO") or str.contains(u, "‚ú®") ? 4 :
     str.contains(u, "‚òÄ") and str.contains(u, "‚Üë") ? 0 :
     str.contains(u, "‚òÄ") and str.contains(u, "‚Üì") ? 1 :
     str.contains(u, "üåô") and str.contains(u, "‚Üë") ? 2 :
     str.contains(u, "üåô") and str.contains(u, "‚Üì") ? 3 :
     5

var tsArr = array.new_int()
var iconIdArr = array.new_int()
var cityIdArr = array.new_int()
var shownArr = array.new_bool()

if barstate.isfirst
    clean = entriesInput
    clean := str.replace_all(clean, ";", ",")
    clean := str.replace_all(clean, "\n", ",")
    clean := str.replace_all(clean, "\r", ",")

    parts = str.split(clean, ",")
    for i = 0 to array.size(parts) - 1
        raw = str.trim(array.get(parts, i))
        if str.length(raw) > 0 and not str.startswith(raw, "#")
            fields = str.split(raw, "|")
            dt = array.size(fields) >= 1 ? str.trim(array.get(fields, 0)) : ""
            icon = array.size(fields) >= 2 ? str.trim(array.get(fields, 1)) : "‚Ä¢"
            city = array.size(fields) >= 3 ? str.trim(array.get(fields, 2)) : ""

            ts = f_ts(dt)
            if not na(ts)
                array.push(tsArr, ts)
                array.push(iconIdArr, f_icon_id(icon))
                array.push(cityIdArr, f_city_id(city))
                array.push(shownArr, false)

                lineColor = color.new(#455A64, 65)
                iconId = f_icon_id(icon)
                if iconId == 0 or iconId == 1
                    lineColor := color.new(#FF6D00, 65)
                else if iconId == 2 or iconId == 3
                    lineColor := color.new(#1565C0, 65)
                else if iconId == 4
                    lineColor := color.new(#6A1B9A, 65)

                if showLines
                    line.new(ts, 0, ts, 1,
                        xloc=xloc.bar_time,
                        extend=extend.both,
                        color=lineColor,
                        style=line.style_dotted,
                        width=1)

// Collect first event per bar
evIcon = -1
evCity = -1
evCount = 0

if array.size(tsArr) > 0
    for i = 0 to array.size(tsArr) - 1
        wasShown = array.get(shownArr, i)
        if not wasShown
            ts = array.get(tsArr, i)
            inBar = time <= ts and ts < time_close
            if inBar and showIcons
                if evCount == 0
                    evIcon := array.get(iconIdArr, i)
                    evCity := array.get(cityIdArr, i)
                evCount += 1
                array.set(shownArr, i, true)

hasEvt = showIcons and evCount >= 1

// (colors defined as constants in plotshape section below)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// plotshape per icon √ó city ‚Äì bottom-pinned, auto-stacked
// 27 plotshapes √ó ~2 = ~54 plots, under 64 limit
// Multiple events on same bar stack vertically automatically
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Colors per event type
color SUN_COL   = color.new(#FF6D00, 0)   // warm orange
color SUN_TXT   = #FFF3E0                  // light cream
color MOON_COL  = color.new(#1565C0, 0)   // deep blue
color MOON_TXT  = #E3F2FD                  // light blue
color ASTRO_COL = color.new(#6A1B9A, 0)   // rich purple
color ASTRO_TXT = #F3E5F5                  // light purple

// Use shape.arrowup for the icon, plotchar won't work.
// plotshape text is single-line only, so combine icon+city compactly.
// --- Sunrise (icon 0) √ó 6 cities ---
plotshape(hasEvt and evIcon==0 and evCity==0, title="SU_NY",  style=shape.triangleup, location=location.bottom, text="NY",  textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==0 and evCity==1, title="SU_FRA", style=shape.triangleup, location=location.bottom, text="FRA", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==0 and evCity==2, title="SU_LDN", style=shape.triangleup, location=location.bottom, text="LDN", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==0 and evCity==3, title="SU_TYO", style=shape.triangleup, location=location.bottom, text="TYO", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==0 and evCity==4, title="SU_BER", style=shape.triangleup, location=location.bottom, text="BER", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==0 and evCity==5, title="SU_OTH", style=shape.triangleup, location=location.bottom, text="",    textcolor=SUN_TXT, color=SUN_COL, size=size.small)
// --- Sunset (icon 1) √ó 6 cities ---
plotshape(hasEvt and evIcon==1 and evCity==0, title="SD_NY",  style=shape.triangledown, location=location.bottom, text="NY",  textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==1 and evCity==1, title="SD_FRA", style=shape.triangledown, location=location.bottom, text="FRA", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==1 and evCity==2, title="SD_LDN", style=shape.triangledown, location=location.bottom, text="LDN", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==1 and evCity==3, title="SD_TYO", style=shape.triangledown, location=location.bottom, text="TYO", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==1 and evCity==4, title="SD_BER", style=shape.triangledown, location=location.bottom, text="BER", textcolor=SUN_TXT, color=SUN_COL, size=size.small)
plotshape(hasEvt and evIcon==1 and evCity==5, title="SD_OTH", style=shape.triangledown, location=location.bottom, text="",    textcolor=SUN_TXT, color=SUN_COL, size=size.small)
// --- Moonrise (icon 2) √ó 6 cities ---
plotshape(hasEvt and evIcon==2 and evCity==0, title="MU_NY",  style=shape.triangleup, location=location.bottom, text="NY",  textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==2 and evCity==1, title="MU_FRA", style=shape.triangleup, location=location.bottom, text="FRA", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==2 and evCity==2, title="MU_LDN", style=shape.triangleup, location=location.bottom, text="LDN", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==2 and evCity==3, title="MU_TYO", style=shape.triangleup, location=location.bottom, text="TYO", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==2 and evCity==4, title="MU_BER", style=shape.triangleup, location=location.bottom, text="BER", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==2 and evCity==5, title="MU_OTH", style=shape.triangleup, location=location.bottom, text="",    textcolor=MOON_TXT, color=MOON_COL, size=size.small)
// --- Moonset (icon 3) √ó 6 cities ---
plotshape(hasEvt and evIcon==3 and evCity==0, title="MD_NY",  style=shape.triangledown, location=location.bottom, text="NY",  textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==3 and evCity==1, title="MD_FRA", style=shape.triangledown, location=location.bottom, text="FRA", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==3 and evCity==2, title="MD_LDN", style=shape.triangledown, location=location.bottom, text="LDN", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==3 and evCity==3, title="MD_TYO", style=shape.triangledown, location=location.bottom, text="TYO", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==3 and evCity==4, title="MD_BER", style=shape.triangledown, location=location.bottom, text="BER", textcolor=MOON_TXT, color=MOON_COL, size=size.small)
plotshape(hasEvt and evIcon==3 and evCity==5, title="MD_OTH", style=shape.triangledown, location=location.bottom, text="",    textcolor=MOON_TXT, color=MOON_COL, size=size.small)
// --- Astro (icon 4) ‚Äì diamond shape, no city ---
plotshape(hasEvt and evIcon==4, title="ASTRO", style=shape.diamond, location=location.bottom, text="", textcolor=ASTRO_TXT, color=ASTRO_COL, size=size.small)
// --- OTHER icon (icon 5) ---
plotshape(hasEvt and evIcon==5, title="OTHER", style=shape.circle, location=location.bottom, text="", textcolor=color.white, color=color.new(#455A64, 0), size=size.small)
