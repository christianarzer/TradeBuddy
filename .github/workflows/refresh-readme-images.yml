name: Refresh README Images

on:
  push:
    branches: [main]
    paths:
      - composeApp/**
      - images/mockup-template.html
      - scripts/capture-readme-images.mjs
      - .github/workflows/refresh-readme-images.yml
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  refresh-images:
    name: Refresh README screenshots and showcase
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5

      - name: Build web distribution
        run: |
          chmod +x gradlew
          ./gradlew :composeApp:wasmJsBrowserDistribution --stacktrace --build-cache

      - name: Ensure web index.html exists
        run: |
          DIST_DIR="composeApp/build/dist/wasmJs/productionExecutable"
          if [ ! -f "$DIST_DIR/index.html" ]; then
            JS_FILE="$(find "$DIST_DIR" -maxdepth 1 -name '*.js' | head -n1)"
            if [ -z "$JS_FILE" ]; then
              echo "No JS bundle found in $DIST_DIR"
              exit 1
            fi
            JS_BASENAME="$(basename "$JS_FILE")"
            cat > "$DIST_DIR/index.html" <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>TradeBuddy</title>
            <style>html,body{margin:0;width:100%;height:100%;overflow:hidden;background:#0f1117;}</style>
          </head>
          <body>
            <script src="./__APP_JS__"></script>
          </body>
          </html>
          HTML
            sed -i "s#__APP_JS__#$JS_BASENAME#g" "$DIST_DIR/index.html"
          fi

      - name: Prepare preview root (GitHub Pages path compatible)
        run: |
          rm -rf preview
          mkdir -p preview/TradeBuddy
          cp -R composeApp/build/dist/wasmJs/productionExecutable/. preview/TradeBuddy/

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"

      - name: Start local web server
        run: |
          cd preview
          python3 -m http.server 4173 &
          echo $! > "$GITHUB_WORKSPACE/.server_pid"
          sleep 5

      - name: Install Playwright
        run: npm install --no-save playwright@1.56.1

      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: Capture slate dark/light screenshots
        run: |
          SCREENSHOT_BASE_URL="http://127.0.0.1:4173/TradeBuddy/" node scripts/capture-readme-images.mjs

      - name: Render showcase mockup
        run: |
          npx playwright screenshot \
            --wait-for-timeout 800 \
            --viewport-size=2400,1450 \
            "file://$GITHUB_WORKSPACE/images/mockup-template.html?mode=dark" \
            images/tradebuddy-showcase-slate-dark.png
          npx playwright screenshot \
            --wait-for-timeout 800 \
            --viewport-size=2400,1450 \
            "file://$GITHUB_WORKSPACE/images/mockup-template.html?mode=light" \
            images/tradebuddy-showcase-slate-light.png

      - name: Stop local web server
        if: always()
        run: |
          if [ -f "$GITHUB_WORKSPACE/.server_pid" ]; then
            kill "$(cat "$GITHUB_WORKSPACE/.server_pid")" || true
          fi

      - name: Commit updated images
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add images/screenshot-web-desktop-dark.png images/screenshot-web-mobile-dark.png images/screenshot-web-desktop-light.png images/screenshot-web-mobile-light.png images/tradebuddy-showcase-slate-dark.png images/tradebuddy-showcase-slate-light.png
          if git diff --cached --quiet; then
            echo "No image changes."
            exit 0
          fi
          git commit -m "chore(images): refresh README screenshots and showcase"
          git push
