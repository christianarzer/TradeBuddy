name: Dependabot Auto-Merge (safe)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge for safe updates
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            const title = pr.title.toLowerCase();
            const isMajor = title.includes('major version update');
            const isPatchOrMinor =
              title.includes('bump') && (title.includes(' from ') && title.includes(' to ')) && !isMajor;

            if (!isPatchOrMinor) {
              core.info('Skipping auto-merge: not a patch/minor style update.');
              return;
            }

            await github.graphql(
              `
              mutation($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {pullRequestId: $pullRequestId, mergeMethod: SQUASH}) {
                  pullRequest { number }
                }
              }
              `,
              { pullRequestId: pr.node_id }
            );
            core.info(`Enabled auto-merge for PR #${pr.number}`);
