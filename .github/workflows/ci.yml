name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  actionlint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run actionlint
        uses: reviewdog/action-actionlint@0d952c597ef8459f634d7145b0b044a9699e5e43 # v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-check
          level: error

  super-linter:
    name: Super-Linter
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Lint with Super-Linter
        uses: github/super-linter@b807e99ddd37e444d189cfd2c2ca1274d8ae8ef1 # v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_GITHUB_ACTIONS: false
          VALIDATE_JSCPD: false
          VALIDATE_YAML_PRETTIER: false

  android:
    name: Android (Lint + Build)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@fbcece063590cf3e99cc8f93ed063231c98bf95b # v5

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Android lint
        run: ./gradlew :androidApp:lintDebug --stacktrace --build-cache

      - name: Android debug build
        run: ./gradlew :androidApp:assembleDebug --stacktrace --build-cache

  desktop:
    name: Desktop (Compile + Tests)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@fbcece063590cf3e99cc8f93ed063231c98bf95b # v5

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Desktop compile
        run: ./gradlew :composeApp:compileKotlinDesktop --stacktrace --build-cache

      - name: Desktop tests
        run: ./gradlew :composeApp:desktopTest --stacktrace --build-cache

  web:
    name: Web (Wasm)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@fbcece063590cf3e99cc8f93ed063231c98bf95b # v5

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Compile wasm target
        run: ./gradlew :composeApp:compileKotlinWasmJs --stacktrace --build-cache

      - name: Build web distribution
        run: ./gradlew :composeApp:wasmJsBrowserDistribution --stacktrace --build-cache

  ios:
    name: iOS (Kotlin + Xcode)
    runs-on: macos-latest
    steps:
      - name: Check out code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@fbcece063590cf3e99cc8f93ed063231c98bf95b # v5

      - name: Cache Kotlin/Native compiler
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml', 'gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Compile iOS targets
        run: |
          ./gradlew :composeApp:compileKotlinIosX64 :composeApp:compileKotlinIosSimulatorArm64 --stacktrace --build-cache

      - name: Build iOS app (simulator)
        run: |
          cd iosApp
          xcodebuild \
            -scheme iosApp \
            -configuration Debug \
            -destination 'generic/platform=iOS Simulator' \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO

