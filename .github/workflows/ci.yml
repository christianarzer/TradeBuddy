name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  actionlint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Run actionlint
        uses: reviewdog/action-actionlint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-check
          level: error

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          warn-only: false

  android:
    name: Android (Lint + Build)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Android lint
        run: ./gradlew :androidApp:lintDebug --stacktrace --build-cache

      - name: Android debug build
        run: ./gradlew :androidApp:assembleDebug --stacktrace --build-cache

  desktop:
    name: Desktop (Compile + Tests)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Desktop compile
        run: ./gradlew :composeApp:compileKotlinDesktop --stacktrace --build-cache

      - name: Desktop tests
        run: ./gradlew :composeApp:desktopTest --stacktrace --build-cache

  web:
    name: Web (Wasm)
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Compile wasm target
        run: ./gradlew :composeApp:compileKotlinWasmJs --stacktrace --build-cache

      - name: Build web distribution
        run: ./gradlew :composeApp:wasmJsBrowserDistribution --stacktrace --build-cache

  ios:
    name: iOS (Kotlin + Xcode)
    runs-on: macos-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Cache Kotlin/Native compiler
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml', 'gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Make Gradle executable
        run: chmod +x gradlew

      - name: Compile iOS targets
        run: |
          ./gradlew :composeApp:compileKotlinIosX64 :composeApp:compileKotlinIosSimulatorArm64 --stacktrace --build-cache

      - name: Build iOS app (simulator)
        run: |
          cd iosApp
          xcodebuild \
            -scheme iosApp \
            -configuration Debug \
            -destination 'generic/platform=iOS Simulator' \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO
